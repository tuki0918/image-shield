<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImageShield Browser Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .section {
            margin: 40px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .file-input {
            margin: 10px 0;
            padding: 10px;
            border: 2px dashed #ccc;
            border-radius: 4px;
            text-align: center;
        }
        .file-input.drag-over {
            border-color: #007acc;
            background-color: #f0f8ff;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a99;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .results {
            margin-top: 20px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
        }
        .error {
            color: red;
            background: #ffe6e6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: green;
            background: #e6ffe6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        textarea {
            width: 100%;
            height: 100px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ›¡ï¸ ImageShield Browser Demo</h1>
    <p>ã“ã®ãƒ‡ãƒ¢ã§ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§ç”»åƒã®æš—å·åŒ–ãƒ»æ–­ç‰‡åŒ–ã¨å¾©å·ãƒ»å¾©å…ƒã‚’è©¦ã™ã“ã¨ãŒã§ãã¾ã™ã€‚</p>

    <!-- æš—å·åŒ–ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="section">
        <h2>ğŸ”’ ç”»åƒã®æš—å·åŒ–ã¨æ–­ç‰‡åŒ–</h2>
        <div class="file-input" id="encrypt-dropzone">
            <input type="file" id="encrypt-files" multiple accept="image/*">
            <p>ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„</p>
        </div>
        <div>
            <label>
                ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ (ä»»æ„):
                <input type="password" id="encrypt-key" placeholder="æš—å·åŒ–ã‚­ãƒ¼ã‚’å…¥åŠ›">
            </label>
        </div>
        <button id="encrypt-btn" disabled>æš—å·åŒ–ã—ã¦æ–­ç‰‡åŒ–</button>
        <div id="encrypt-results" class="results" style="display: none;"></div>
    </div>

    <!-- å¾©å·ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="section">
        <h2>ğŸ”“ æ–­ç‰‡ã®å¾©å·ã¨å¾©å…ƒ</h2>
        <div class="file-input" id="decrypt-dropzone">
            <input type="file" id="decrypt-files" multiple accept=".png,.json">
            <p>æ–­ç‰‡ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.pngï¼‰ã¨ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆï¼ˆmanifest.jsonï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
        </div>
        <div>
            <label>
                ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ (æš—å·åŒ–ã—ãŸå ´åˆ):
                <input type="password" id="decrypt-key" placeholder="å¾©å·ã‚­ãƒ¼ã‚’å…¥åŠ›">
            </label>
        </div>
        <button id="decrypt-btn" disabled>å¾©å·ã—ã¦å¾©å…ƒ</button>
        <div id="decrypt-results" class="results" style="display: none;"></div>
    </div>

    <!-- ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆè¡¨ç¤º -->
    <div class="section">
        <h2>ğŸ“‹ ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆæƒ…å ±</h2>
        <textarea id="manifest-display" readonly placeholder="æš—å·åŒ–å¾Œã€ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆæƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
    </div>

    <script type="module">
        import BrowserImageShield from './dist/image-shield-browser.es.js';

        // UI Elements
        const encryptFiles = document.getElementById('encrypt-files');
        const encryptBtn = document.getElementById('encrypt-btn');
        const encryptResults = document.getElementById('encrypt-results');
        const encryptKey = document.getElementById('encrypt-key');

        const decryptFiles = document.getElementById('decrypt-files');
        const decryptBtn = document.getElementById('decrypt-btn');
        const decryptResults = document.getElementById('decrypt-results');
        const decryptKey = document.getElementById('decrypt-key');

        const manifestDisplay = document.getElementById('manifest-display');

        // Encrypt functionality
        encryptFiles.addEventListener('change', () => {
            encryptBtn.disabled = encryptFiles.files.length === 0;
        });

        encryptBtn.addEventListener('click', async () => {
            try {
                encryptBtn.disabled = true;
                encryptResults.innerHTML = '<p>å‡¦ç†ä¸­...</p>';
                encryptResults.style.display = 'block';

                const files = Array.from(encryptFiles.files);
                const secretKey = encryptKey.value || undefined;

                const result = await BrowserImageShield.encrypt({
                    images: files,
                    secretKey: secretKey
                });

                // Display manifest
                manifestDisplay.value = JSON.stringify(result.manifest, null, 2);

                // Download all files
                await BrowserImageShield.downloadFiles(result);

                encryptResults.innerHTML = `
                    <div class="success">
                        <h3>âœ… æš—å·åŒ–å®Œäº†</h3>
                        <p>å‡¦ç†ã•ã‚ŒãŸç”»åƒ: ${files.length}æš</p>
                        <p>ç”Ÿæˆã•ã‚ŒãŸæ–­ç‰‡: ${Object.keys(result.files).length - 1}å€‹</p>
                        <p>ã‚»ã‚­ãƒ¥ã‚¢: ${result.manifest.secure ? 'ã¯ã„' : 'ã„ã„ãˆ'}</p>
                    </div>
                `;
            } catch (error) {
                encryptResults.innerHTML = `<div class="error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            } finally {
                encryptBtn.disabled = false;
            }
        });

        // Decrypt functionality
        decryptFiles.addEventListener('change', () => {
            const files = Array.from(decryptFiles.files);
            const hasManifest = files.some(f => f.name === 'manifest.json');
            const hasFragments = files.some(f => f.name.endsWith('.png'));
            decryptBtn.disabled = !hasManifest || !hasFragments;
        });

        decryptBtn.addEventListener('click', async () => {
            try {
                decryptBtn.disabled = true;
                decryptResults.innerHTML = '<p>å‡¦ç†ä¸­...</p>';
                decryptResults.style.display = 'block';

                const files = Array.from(decryptFiles.files);
                const manifestFile = files.find(f => f.name === 'manifest.json');
                const fragmentFiles = files.filter(f => f.name.endsWith('.png'));

                // Read manifest
                const manifestText = await manifestFile.text();
                const manifestData = JSON.parse(manifestText);

                const secretKey = decryptKey.value || undefined;

                const result = await BrowserImageShield.decrypt({
                    fragmentFiles: fragmentFiles,
                    manifestData: manifestData,
                    secretKey: secretKey
                });

                // Download restored images
                await BrowserImageShield.downloadImages(result);

                decryptResults.innerHTML = `
                    <div class="success">
                        <h3>âœ… å¾©å·å®Œäº†</h3>
                        <p>å¾©å…ƒã•ã‚ŒãŸç”»åƒ: ${result.images.length}æš</p>
                        <p>ãƒ•ã‚¡ã‚¤ãƒ«å: ${result.originalNames.join(', ')}</p>
                    </div>
                `;
            } catch (error) {
                decryptResults.innerHTML = `<div class="error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            } finally {
                decryptBtn.disabled = false;
            }
        });

        // Drag and drop functionality
        function setupDragAndDrop(dropzone, fileInput) {
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('drag-over');
            });

            dropzone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropzone.classList.remove('drag-over');
            });

            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('drag-over');
                fileInput.files = e.dataTransfer.files;
                fileInput.dispatchEvent(new Event('change'));
            });
        }

        setupDragAndDrop(document.getElementById('encrypt-dropzone'), encryptFiles);
        setupDragAndDrop(document.getElementById('decrypt-dropzone'), decryptFiles);
    </script>
</body>
</html>
